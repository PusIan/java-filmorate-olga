-- for start
--create user sa superuser;
--alter user sa password 'password';
--create database filmorate with owner sa;


 -- for tests
DROP TABLE IF EXISTS rating_mpa CASCADE;
DROP TABLE IF EXISTS friendship CASCADE;
DROP TABLE IF EXISTS films CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS films CASCADE;
DROP TABLE IF EXISTS likes CASCADE;
DROP TABLE IF EXISTS genres CASCADE;
DROP TABLE IF EXISTS film_genre CASCADE;


CREATE TABLE IF NOT EXISTS rating_mpa(
        id INTEGER  GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name VARCHAR(50) NOT NULL,
        description VARCHAR(255)
);

CREATE TABLE IF NOT EXISTS genres(
        id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name VARCHAR
);

CREATE TABLE IF NOT EXISTS films(
        id INTEGER generated by default as identity primary key,
        name VARCHAR NOT NULL CHECK (name <> ''),
        description VARCHAR(255) NOT NULL,
        realise_date DATE,
        duration INTEGER CHECK (duration > 0),
        rating_id INTEGER,
        FOREIGN  KEY (rating_id) REFERENCES rating_mpa(id) ON DELETE SET NULL,
        CONSTRAINT exist_film_name UNIQUE (name)
);

CREATE TABLE IF NOT EXISTS film_genre(
        film_id INTEGER REFERENCES film (id) ON DELETE CASCADE,
        genre_id INTEGER REFERENCES genres (id) ON DELETE CASCADE,
        PRIMARY KEY(film_id, genre_id)
);

CREATE TABLE IF NOT EXISTS users(
        id INTEGER generated by default as identity primary key,
        name varchar(255) NOT NULL,
        login VARCHAR(50) NOT NULL,
        email VARCHAR   NOT NULL,
        birthday DATE NOT NULL,
        CONSTRAINT user_const CHECK (login <> '' AND email <> '' )
);


CREATE TABLE IF NOT EXISTS friendship(
        user_id INTEGER REFERENCES users (id) ON DELETE CASCADE,
        friend_user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
        friend_status BOOLEAN NOT NULL,
        PRIMARY KEY (user_id, friend_user_id)
);

CREATE TABLE IF NOT EXISTS likes(
        film_id INTEGER REFERENCES films (id) ON DELETE CASCADE,
        user_id INTEGER REFERENCES users (id) ON DELETE CASCADE,
        PRIMARY KEY(user_id, film_id)
);
